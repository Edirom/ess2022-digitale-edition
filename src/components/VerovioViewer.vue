<template>
  <div class="verovioComponent">
    <SourceSelectionButtons/>
    <div id="verovioViewer">
      this will go away automatically as soon as MEI is renderedâ€¦
    </div>
  </div>
</template>

<script>
import createVerovioModule from 'verovio/wasm'
import { VerovioToolkit } from 'verovio/esm'
import SourceSelectionButtons from '@/components/SourceSelectionButtons.vue'

const verovioOptions = {
  scale: 50,
  breaks: 'encoded',
  openControlEvents: true,
  svgBoundingBoxes: true,
  svgViewBox: true,
  svgRemoveXlink: true,
  header: 'none',
  footer: 'none',
  appXPathQuery: './rdg[contains(@source, "#jakob")]',
  choiceXPathQuery: './orig',
  svgAdditionalAttribute: [
    'note@pname',
    'note@oct'
  ],
  transpose: '-M2'
}

export default {
  name: 'VerovioViewer',
  components: {
    SourceSelectionButtons
  },
  mounted: function () {
    createVerovioModule().then(VerovioModule => {
      this.verovioToolkit = new VerovioToolkit(VerovioModule)
      this.verovioToolkit.setOptions(verovioOptions)

      if (this.$store.getters.meiLoaded) {
        this.verovioToolkit.loadData(this.$store.getters.meiAsText)

        // attention: down there be dragons!
        // verovioToolkit.select({ measureRange: '3-5' })
        // verovioToolkit.redoLayout()

        const svg = this.verovioToolkit.renderToSVG(1, {})
        document.querySelector('#verovioViewer').innerHTML = svg
      }
    })
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style lang="scss">
@import '@/css/_variables.scss';

.verovioComponent {
  width: 100%;
  height: 100%;
}

#verovioViewer {
  width: 100%;
  height: calc(100% - $sourceSelectionButtonsHeight);
  overflow: auto;

  svg {
    g.app {
      fill: lighten(red, 20%);
      stroke: lighten(red, 20%);
    }

    g.note[data-pname="c"][data-oct="4"] {
      fill: blue;
      stroke: blue;
    }
  }
}
</style>
